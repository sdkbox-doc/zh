<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">

	<title>In-App Purchases(IAP) with Lua - SDKBOX</title>
        
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../../css/base.css?2" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <link href="../../../css/custom.css" rel="stylesheet">
        

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="http://sdkbox.com"><img src="http://www.cocos2d-x.org/s/sdkbox/SDKBOX_logo.png">Docs</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">

            <ul class="nav navbar-nav navbar-right">


            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../..">简介</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cocos <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../cocos/">安装方式</a>
</li>

                        
                            
<li >
    <a href="../../../installer/">命令行工具</a>
</li>

                        
                            
<li >
    <a href="../../../qa/cocos_creator/">Creator集成</a>
</li>

                        
                            
  
  <li class="dropdown-submenu">
    <a tabindex="-1" class="non-link">SDK插件</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../achievement/">Achievements</a>
</li>

        
            
  

        
            
<li >
    <a href="../../adcolony/">AdColony</a>
</li>

        
            
  

        
            
<li >
    <a href="../../admob/">AdMob</a>
</li>

        
            
  

        
            
<li >
    <a href="../../agecheq/">AgeCheq</a>
</li>

        
            
  

        
            
<li >
    <a href="../../appnext/">Appnext</a>
</li>

        
            
  

        
            
<li >
    <a href="../../appodeal/">Appodeal</a>
</li>

        
            
  

        
            
<li >
    <a href="../../amazon/">Amazon</a>
</li>

        
            
  

        
            
<li >
    <a href="../../apteligent/">Apteligent</a>
</li>

        
            
  

        
            
<li >
    <a href="../../bee7/">Bee7</a>
</li>

        
            
  

        
            
<li >
    <a href="../../chartboost/">Chartboost</a>
</li>

        
            
  

        
            
<li >
    <a href="../../ethwallet/">EthWallet</a>
</li>

        
            
<li >
    <a href="../../facebook/">Facebook</a>
</li>

        
            
  

        
            
<li >
    <a href="../../gameroom/">Facebook Gameroom</a>
</li>

        
            
  

        
            
<li >
    <a href="../../firebase/">Firebase</a>
</li>

        
            
  

        
            
<li >
    <a href="../../flurryanalytics/">Flurry Analytics</a>
</li>

        
            
  

        
            
<li >
    <a href="../../fyber/">Fyber</a>
</li>

        
            
  

        
            
<li >
    <a href="../../googleanalytics/">Google Analytics</a>
</li>

        
            
  

        
            
<li >
    <a href="../../googleplay/">Google Play Game</a>
</li>

        
            
  

        
            
<li >
    <a href="../../hms/">Huawei Mobile Services</a>
</li>

        
            
  

        
            
<li >
    <a href="../">In-App Purchase</a>
</li>

        
            
  

        
            
<li >
    <a href="../../inmobi/">InMobi</a>
</li>

        
            
  

        
            
<li >
    <a href="../../kochava/">Kochava</a>
</li>

        
            
  

        
            
<li >
    <a href="../../leadbolt/">LeadBolt</a>
</li>

        
            
  

        
            
<li >
    <a href="../../leaderboard/">Leaderboard</a>
</li>

        
            
  

        
            
<li >
    <a href="../../misc/">Misc</a>
</li>

        
            
  

        
            
<li >
    <a href="../../playphone/">Playphone</a>
</li>

        
            
  

        
            
<li >
    <a href="../../review/">Ratings & Reviews</a>
</li>

        
            
  

        
            
<li >
    <a href="../../sdkboxads/">SDKBOX Ads</a>
</li>

        
            
  

        
            
<li >
    <a href="../../sdkboxplay/">SDKBOX Play</a>
</li>

        
            
  

        
            
<li >
    <a href="../../share/">Social Sharing</a>
</li>

        
            
  

        
            
<li >
    <a href="../../signinwithapple/">Sign in with Apple</a>
</li>

        
            
  

        
            
<li >
    <a href="../../tune/">Tune</a>
</li>

        
            
  

        
            
<li >
    <a href="../../unityads/">UnityAds</a>
</li>

        
            
  

        
            
<li >
    <a href="../../valuepotion/">Valuepotion</a>
</li>

        
            
  

        
            
<li >
    <a href="../../vungle/">Vungle</a>
</li>

        
            
  

        
            
<li >
    <a href="../../youtube/">Youtube</a>
</li>

        
            
  

        
    </ul>
  </li>
  

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Unity <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../unity/iap/">In-App Purchase</a>
</li>

                        
                            
<li >
    <a href="../../../unity/review/">Ratings & Reviews</a>
</li>

                        
                            
<li >
    <a href="../../../unity/socialshare/">SocialShare</a>
</li>

                        
                            
<li >
    <a href="../../../unity/googleanalytics/documentation/">Google Analytics</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Unreal <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../unreal/iap/">In-App Purchase</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">LiveOps <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../liveops/">使用介绍</a>
</li>

                        
                            
<li >
    <a href="../../../liveops/remote-config/">远程配置</a>
</li>

                        
                            
<li >
    <a href="../../../liveops/receipt-verification/">服务器端IAP订单校验</a>
</li>

                        
                            
<li >
    <a href="../../../liveops/catalog-management/">即时可购买项目管理</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">指南 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../qa/installgoogleplaystore/">GooglePlay安装指南</a>
</li>

                        
                            
<li >
    <a href="../../../qa/integration-admob-to-creator/">AdMob集成指南</a>
</li>

                        
                            
<li >
    <a href="../../../qa/install_sdkbox/">SDKBox安装</a>
</li>

                        
                            
<li >
    <a href="../../../qa/crypt-sdkbox-config/">保护 sdkbox_config.json</a>
</li>

                        
                            
<li >
    <a href="../../../qa/sdkboxplay_troubleshoot/">SDKBoxPlay相关问题</a>
</li>

                        
                            
<li >
    <a href="../../../qa/iap_troubleshoot/">IAP相关问题</a>
</li>

                        
                            
<li >
    <a href="../../../qa/sdkbox_installer_issue/">Installer相关问题</a>
</li>

                        
                            
<li >
    <a href="../../../qa/cmake_xcframework/">CMake With XCFramework</a>
</li>

                        
                        </ul>
                    </li>
                
                

                <li style="margin-left:30px">
 <a href="http://sdkbox-doc.github.io/en/">English</a>
                </li>
                
                </ul>
            




            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#ios-">新手 《iOS内购 - 账户信息填写》</a></li>
        <li class="main "><a href="#_1">集成</a></li>
        <li class="main "><a href="#_2">重点注意事项</a></li>
            <li><a href="#_3">禁用应用程序安全传输策略</a></li>
            <li><a href="#bitcode">禁止 Bitcode 支持</a></li>
            <li><a href="#_4">游戏全屏配置</a></li>
            <li><a href="#canopenurl">canOpenURL 白名单</a></li>
            <li><a href="#json">JSON 配置</a></li>
            <li><a href="#ios">iOS 测试</a></li>
            <li><a href="#android">Android 测试</a></li>
            <li><a href="#skpaymenttransactionstatedeferred">SKPaymentTransactionStateDeferred 测试</a></li>
            <li><a href="#_5">初始化时机</a></li>
        <li class="main "><a href="#_6">使用</a></li>
            <li><a href="#lua">修改 Lua 代码</a></li>
            <li><a href="#iap">初始化 IAP</a></li>
            <li><a href="#_7">获取最新的商品数据</a></li>
            <li><a href="#_8">购买</a></li>
            <li><a href="#_9">恢复购买</a></li>
            <li><a href="#_10">处理付费事件</a></li>
        <li class="main "><a href="#promotion-iap">Promotion IAP</a></li>
            <li><a href="#promotion-iap_1">启用 Promotion IAP</a></li>
            <li><a href="#promotion-iap_2">Promotion IAP 设置</a></li>
        <li class="main "><a href="#api-reference">API Reference</a></li>
            <li><a href="#methods">Methods</a></li>
            <li><a href="#listeners">Listeners</a></li>
        <li class="main "><a href="#_11">手动集成</a></li>
        <li class="main "><a href="#ios_1">iOS 平台手动集成</a></li>
        <li class="main "><a href="#android_1">Android 平台手动集成</a></li>
            <li><a href="#_12">拷贝文件</a></li>
            <li><a href="#androidmanifestxml">编辑 AndroidManifest.xml</a></li>
            <li><a href="#androidmk">编辑 Android.mk</a></li>
            <li><a href="#applicationmk-cocos2d-x-v30-v32">编辑 Application.mk （只限 Cocos2d-x v3.0 到 v3.2 版本）</a></li>
            <li><a href="#appactivityjava">修改 AppActivity.java</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p><a href="../">&#8249; IAP Doc Home</a></p>
<h1>IAP 集成指南</h1>

<h4><em><b>For the Lua version of cocos2d-x v3.x</b> - (<a href="./../">all other versions</a>)</em></h4>

<h2 id="ios-">新手 《iOS内购 - 账户信息填写》</h2>
<ol>
<li><a href="https://help.apple.com/app-store-connect/?lang=zh-cn/#/devb57be10e7">App Store Connect 帮助 - App 内购买项目配置流程</a></li>
<li><a href="https://www.jianshu.com/p/4f5f0b45b083">https://www.jianshu.com/p/4f5f0b45b083</a></li>
<li><a href="http://xiaovv.me/2018/05/03/My-iOS-In-App-Purchase-Summarize/">http://xiaovv.me/2018/05/03/My-iOS-In-App-Purchase-Summarize/</a></li>
</ol>
<h2 id="_1">集成</h2>
<p>用如下命令来集成 SDKBOX IAP 插件,请确保您可以正常执行的 SDKBOX 安装器.</p>
<pre><code class="bash">sdkbox import iap
</code></pre>

<!--
## ~~从 China 服务器下载~~ 服务器已停止
如果你在中国, 并且下载插件的速度比较慢, 可以尝试使用位于中国的服务器来下载, 查询插件, 使用方法为在你的 `sdkbox import` 后加 `--server china` 及可, 比如:

<pre><code class="bash">sdkbox import xxx  --server china
</code></pre>

xxx 为你的插件名字
-->

<h2 id="_2">重点注意事项</h2>
<p>如果您升级到了 Xcode7, 则需要以下额外步骤来确保插件工作正常:</p>
<h4 id="_3">禁用应用程序安全传输策略</h4>
<p>添加以下项到 plist:</p>
<pre><code>&lt;key&gt;NSAppTransportSecurity&lt;/key&gt;
&lt;dict&gt;
    &lt;key&gt;NSAllowsArbitraryLoads&lt;/key&gt;
    &lt;true/&gt;
&lt;/dict&gt;
</code></pre>

<p>添加后的文件内容看起来就像这样：</p>
<p><img alt="" src="../../../imgs/ATS.png" /></p>
<h4 id="bitcode">禁止 Bitcode 支持</h4>
<p>您必须禁止 <strong>Bitcode</strong> 的支持，否则将会编译失败。</p>
<h4 id="_4">游戏全屏配置</h4>
<p>如果您的游戏不同时支持横竖屏，则必须在 Xcode 中选中 <code>Requires full screen</code>，否则将不会通过 Apple 的审核。</p>
<h4 id="canopenurl">canOpenURL 白名单</h4>
<p>取决于您使用哪些插件。需要在 <code>info.plist</code> 的 <code>LSApplicationQueriesSchemes</code> 下添加名单。</p>
<!--## Configuration
### SDKBOX Cloud
SDKBOX Cloud enables developers to receive the benefits of a centralized application management interface, by helping to boost their applications with extended functionality. The two main features are: __Remote Application Management__ which provides the abilities of updating and testing, and __IAP Receipt Verification__.

Developers must register at Chukong’s website to get __developers credentials__. After receiving __developers credentials__, developers can register an unlimited number of __applications__. Each __application__ will have an associated __application token__ and a __application secret__. These are used to securely transmit new plugin configurations to the clients as well as grant access to all the remotely accessible services.

### Remote Application Configuration
SDKBOX allows developers to create a __Remote Application Configuration__ for each application they are developing.

Registering the applications’ allows for on-the-fly update of its plugin’s configuration. For example, it will allow the change of the Google Analytics tracking code, switch to a new AdColony campaign or add new in-app purchase products without rebuilding and redeploying your apps to the app stores.

To enable this cloud service in your applications is as easy as calling a single __init()__ function and passing in your __application token__ and __application secret__ that were provided when you created the app in the previous section.

<pre><code>sdkbox::init( &lt;application token&gt;, &lt;application secret&gt; );
</code></pre>

  __Note__: each application will have it’s own __application token__ and each configuration for each game will have it’s own __application secret__. The __application secret__ is the actual encryption key used to decipher the remote configuration.

When the developer updates a __Remote Application Configuration__ the application will automatically pull the new configuration and put it into effect. This means that you can update configuration information on the fly and everyone playing your game will get updated the next time the user starts the application!

To ensure security, during normal execution the new configuration is locally saved in the applications’s private folder, and the next time it restarts it is applied. Also, configurations are cyphered and its contents are not exposed, even if your application runs on a rooted/jailbroken device.
-->

<h3 id="json">JSON 配置</h3>
<p>SDKBOX 安装器会自动在您的工程中添加一个样例配置文件<code>sdkbox_config.json</code>.在您编译工程前,请修改里面的参数,用您自己的应用信息</p>
<p>现在给一个修改例子,您需要在<a href="http://itunesconnect.apple.com">iTunes Connect</a>获取一个应用id,然后替换 <code>&lt;put the product id for ios here&gt;</code>,或者,在<a href="https://play.google.com/apps/publish">Google Play Console</a>申请一个应用id,并替换<code>&lt;put your googleplay key here&gt;</code></p>
<pre><code class="json">&quot;ios&quot; :
{
    &quot;iap&quot;:{
        &quot;items&quot;:{
            &quot;remove_ads&quot;:{
                &quot;id&quot;:&quot;&lt;put the product id for ios here&gt;&quot;
            }
        }
    }
},
&quot;android&quot;:
{
    &quot;iap&quot;:{
        &quot;key&quot;:&quot;&lt;put your googleplay key here&gt;&quot;,
        &quot;items&quot;:{
            &quot;coins&quot;:{ // 这是可消耗商品
                &quot;id&quot;:&quot;&lt;put the product id for android here&gt;&quot;
            },
            &quot;remove_ads&quot;:{
                &quot;id&quot;:&quot;&lt;put the product id for android here&gt;&quot;,
                &quot;type&quot;:&quot;non_consumable&quot; // 这是不可消耗商品
            },
            &quot;subscription_item&quot;:{
                &quot;id&quot;:&quot;&lt;put the product id for android here&gt;&quot;,
                &quot;type&quot;:&quot;subs&quot; // 这是订阅商品
            }
        }
    }
}
</code></pre>

<p><strong>注意</strong>: sdkbox_config.json 中的 Goolge IAP key 是从 <code>Google Play Console</code> 中取到的, Google Console-&gt;Developer Tools-&gt;Services &amp; APIs, 请看如下截图:</p>
<p><img alt="" src="../../../imgs/google_licensing_iab.png" /></p>
<h3 id="ios">iOS 测试</h3>
<ul>
<li>iOS 模拟器不支持购买测试，请使用物理设备进行购买测试</li>
<li>您需要用 iTunesConnect 账户创建一个测试 IAP 的测试账号</li>
</ul>
<h3 id="android">Android 测试</h3>
<ol>
<li>编译 release 版本，并在谷歌发布 alpha 或者 beta 渠道</li>
<li>必须是 alpha 或者 beta 渠道的测试者</li>
<li>使用您的 <code>秘钥</code> 替换 <code>sdkbox_config.json</code> 中的 <code>IAP</code> -&gt; <code>Android</code> -&gt;  <code>key</code> 字段. 登录 <a href="https://play.google.com/apps/publish/">https://play.google.com/apps/publish/</a>, 打开对应的游戏, 菜单 "Development tools -&gt; Services &amp; APIs -&gt; in-app billing"</li>
</ol>
<h3 id="skpaymenttransactionstatedeferred"><code>SKPaymentTransactionStateDeferred</code> 测试</h3>
<p><code>SKPaymentTransactionStateDeferred</code> 是 iOS IAP 订单的一个中间状态. 对于大部数开发者而言, 不用关心这个中间状态.</p>
<p>如果你需要测试 <code>SKPaymentTransactionStateDeferred</code> 的话，可以在 <code>sdkbox_config.json</code> 中添加 <code>simulatesAskToBuyInSandbox</code> 项, 如下:</p>
<pre><code class="json">&quot;ios&quot;:
{
    &quot;iap&quot;: {
        &quot;simulatesAskToBuyInSandbox&quot;: true,
        &quot;items&quot;: { ... }
    }
}
</code></pre>

<p>更多关于 <a href="https://stackoverflow.com/questions/25510678/how-to-test-skpaymenttransactionstatedeferred">SKPaymentTransactionStateDeferred</a></p>
<h3 id="_5">初始化时机</h3>
<p>IAP 的初始化, 请注意以下几点:</p>
<ol>
<li>App 启动后, 尽量早地初始化 IAP .</li>
<li>请先 setListener , 再 init .</li>
<li>如果有多个插件, IAP 的 init 应首先调用.</li>
</ol>
<h2 id="_6">使用</h2>
<h3 id="lua">修改 Lua 代码</h3>
<p>修改 <code>./frameworks/runtime-src/Classes/lua_module_register.h</code> 以包含如下必须头文件, 并调用 <code>IAP</code> 的lua注册函数.注意它们的参数 <strong>lua_State*</strong> :</p>
<pre><code class="cpp">#include &quot;PluginIAPLua.hpp&quot;
#include &quot;PluginIAPLuaHelper.h&quot;
</code></pre>

<pre><code class="cpp">static int lua_module_register(lua_State* L)
{
  register_all_PluginIAPLua(L);
  register_all_PluginIAPLua_helper(L);
}
</code></pre>

<h3 id="iap">初始化 IAP</h3>
<p>修改您的lua代码去初始插件, 初始化可以在任何地方来做,但是必须要在您想使用插件的功能之前.</p>
<pre><code class="lua">sdkbox.IAP:init()
</code></pre>

<h3 id="_7">获取最新的商品数据</h3>
<p>最好在您的游戏开始前从服务器获取一次最新的商品数据</p>
<p>要获取商品数据,只需要简单调用 <code>sdkbox.IAP:refresh()</code>.</p>
<blockquote>
<p><code>onProductRequestSuccess</code> 获取成功会收到这个事件.</p>
<p><code>onProductRequestFailure</code> 获取失败收到这个事件.</p>
</blockquote>
<h3 id="_8">购买</h3>
<p>购买商口调用 <code>sdkbox.IAP:purchase(name)</code></p>
<p><strong>注意:</strong> <strong>name</strong> 是您工程的 IAP 配置文件中的 <code>items</code> 项下的名字,而不是您在 iTunes 或 GooglePlay Store中的商品名</p>
<blockquote>
<p><code>onSuccess</code> 购买成功事件.</p>
<p><code>onFailure</code> 购买失败事件.</p>
<p><code>onCanceled</code> 用户取消购买,会触发这个事件.</p>
</blockquote>
<h3 id="_9">恢复购买</h3>
<p>恢复购买调用 <code>sdkbox.IAP:restore()</code>.</p>
<blockquote>
<p><code>onRestored</code> 恢复成功事件.</p>
</blockquote>
<p><strong>注意:</strong> <code>onRestored</code> 可能被会多次触发</p>
<h3 id="_10">处理付费事件</h3>
<p>您可以接收付费过程中的 <code>IAP</code> 事件, 不同事件对用户, IAP 服务器做不同的处理.</p>
<pre><code class="lua">sdkbox.IAP:setListener(function(args)
        if &quot;onSuccess&quot; == args.event then
                local product = args.product
                dump(product, &quot;onSuccess:&quot;)
        elseif &quot;onFailure&quot; == args.event then
                local product = args.product
                local msg = args.msg
                dump(product, &quot;onFailure:&quot;)
                print(&quot;msg:&quot;, msg)
        elseif &quot;onCanceled&quot; == args.event then
                local product = args.product
                dump(product, &quot;onCanceled:&quot;)
        elseif &quot;onRestored&quot; == args.event then
                local product = args.product
                dump(product, &quot;onRestored:&quot;)
        elseif &quot;onProductRequestSuccess&quot; == args.event then
                local products = args.products
                dump(products, &quot;onProductRequestSuccess:&quot;)
        elseif &quot;onProductRequestFailure&quot; == args.event then
                local msg = args.msg
                print(&quot;msg:&quot;, msg)
        else
                print(&quot;unknow event &quot;, args.event)
        end
end)
</code></pre>

<h2 id="promotion-iap">Promotion IAP</h2>
<h3 id="promotion-iap_1">启用 Promotion IAP</h3>
<p>如果你想使用 iOS Promoting IAP 的话:</p>
<ol>
<li>实现 <code>IAPListener</code> 中的 <code>onShouldAddStorePayment</code>.</li>
<li>在 <code>itunes connect</code> 网页中做相关配置</li>
</ol>
<p>现在在 <code>onShouldAddStorePayment</code> 中，我们默认返回 true. 所以每次用户在 store 中点击，都会弹出购买提示。
如果你的应用有存在需要取消购买或延迟购买的情况，你需要在这个回调中实现自己的逻辑来返回 true 或 false.</p>
<h3 id="promotion-iap_2">Promotion IAP 设置</h3>
<p>你可以设置 promotion iap 商品在不同手机显示不同的商品，或以不同的顺序显示:</p>
<ol>
<li><code>sdkbox.IAP.updateStorePromotionOrder({"remove_ads"})</code>;</li>
<li><code>sdkbox.IAP.updateStorePromotionVisibility('remove_ads', true)</code>;</li>
<li><code>sdkbox.IAP.fetchStorePromotionOrder()</code>;</li>
<li><code>sdkbox.IAP.fetchStorePromotionVisibility('remove_ads')</code>;</li>
</ol>
<p>更多详情见<a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/StoreKitGuide/PromotingIn-AppPurchases/PromotingIn-AppPurchases.html">Promoting IAP 官方文档</a></p>
<h2 id="api-reference">API Reference</h2>
<h3 id="methods">Methods</h3>
<pre><code class="lua">sdkbox.IAP:init(jsonconfig)
</code></pre>

<blockquote>
<p>Initialize SDKBox IAP</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:setDebug(debug)
</code></pre>

<blockquote>
<p>Enable/disable debug logging</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:purchase(name)
</code></pre>

<blockquote>
<p>Make a purchase request</p>
</blockquote>
<pre>
@Param name is the name of the item specified in sdkbox_config.json
</pre>

<pre><code class="lua">sdkbox.IAP:refresh()
</code></pre>

<blockquote>
<p>Refresh the IAP data(title, price, description)</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:restore()
</code></pre>

<blockquote>
<p>Restore purchase</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:setListener(listener)
</code></pre>

<blockquote>
<p>Set listener for IAP</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:removeListener()
</code></pre>

<blockquote>
<p>Remove listener for IAP</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:enableUserSideVerification()
</code></pre>

<pre><code class="lua">sdkbox.IAP:isAutoFinishTransaction()
</code></pre>

<blockquote>
<p>get auto invoke finishTransaction flag</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:setAutoFinishTransaction(b)
</code></pre>

<blockquote>
<p>set auto invoke finishTransaction flag</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:finishTransaction(productid)
</code></pre>

<blockquote>
<p>to invoke ios finishTransaction api</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:fetchStorePromotionOrder()
</code></pre>

<pre><code class="lua">sdkbox.IAP:updateStorePromotionOrder(productNames)
</code></pre>

<pre><code class="lua">sdkbox.IAP:fetchStorePromotionVisibility(productName)
</code></pre>

<pre><code class="lua">sdkbox.IAP:updateStorePromotionVisibility(productName, visibility)
</code></pre>

<pre><code class="lua">sdkbox.IAP:getPurchaseHistory();
</code></pre>

<blockquote>
<p>get all purchase history, include cancelled, expired</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:getInitializedErrMsg();
</code></pre>

<blockquote>
<p>get initialized error message</p>
</blockquote>
<pre><code class="lua">sdkbox.IAP:requestUpdateTransaction();
</code></pre>

<blockquote>
<p>request all unfinish transaction, and retrigger onSuccess, onFailed or onCancel event with corresponding transaction.</p>
<p>just valid on iOS</p>
<p>e.g. if there have two transaction (one is success, on is canceled) havn't been finish,
     after invoke requestUpdateTransaction, onSuccess will trigger with the success transaction, onCancelled will trigger with the cancelled transaction.</p>
<p>Note: for most developer, this api is needn't, onSuccess, onFailed or onCancel will auto trigger when transaction updated.</p>
</blockquote>
<h3 id="listeners">Listeners</h3>
<pre><code class="lua">onInitialized(success)
</code></pre>

<blockquote>
<p>Called when IAP initialized</p>
</blockquote>
<pre><code class="lua">onSuccess(p)
</code></pre>

<blockquote>
<p>Called when an IAP processed successfully</p>
</blockquote>
<pre><code class="lua">onFailure(p, msg)
</code></pre>

<blockquote>
<p>Called when an IAP fails</p>
</blockquote>
<pre><code class="lua">onCanceled(p)
</code></pre>

<blockquote>
<p>Called when user canceled the IAP</p>
</blockquote>
<pre><code class="lua">onRestored(p)
</code></pre>

<blockquote>
<p>Called when server returns the IAP items user already purchased
@note this callback will be called multiple times if there are multiple IAP</p>
</blockquote>
<pre><code class="lua">onProductRequestSuccess(products)
</code></pre>

<blockquote>
<p>Called the product request is successful, usually developers use product request to update the latest info(title, price) from IAP</p>
</blockquote>
<pre><code class="lua">onProductRequestFailure(msg)
</code></pre>

<blockquote>
<p>Called when the product request fails</p>
</blockquote>
<pre><code class="lua">onRestoreComplete(ok, msg)
</code></pre>

<blockquote>
<p>Called when the restore completed</p>
</blockquote>
<pre><code class="lua">onShouldAddStorePayment(productName)
</code></pre>

<pre><code class="lua">onFetchStorePromotionOrder(productNames, error)
</code></pre>

<pre><code class="lua">onFetchStorePromotionVisibility(productName, visibility, error)
</code></pre>

<pre><code class="lua">onUpdateStorePromotionOrder(error)
</code></pre>

<pre><code class="lua">onUpdateStorePromotionVisibility(error)
</code></pre>

<pre><code class="lua">onPurchaseHistory(purchases)
</code></pre>

<pre><code class="lua">onConsumed(product, error)
</code></pre>

<pre><code class="lua">onDeferred(product)
</code></pre>

<blockquote>
<p>Called when IAP pay deferred</p>
<p>Note: Pay deferred status is a middle status, for most developer, needn't case this status
this status will change to success or failed or cancel, its final status is pending external action.</p>
<p>Please DO NOT finishTransaction when status is deferred.</p>
</blockquote>
<h2 id="_11">手动集成</h2>
<p>如果 <em>SDKBOX 安装器</em> 安装插件失败了，那么需要手动集成插件.如果安装器安装插件成功了,那么不需要，也没必要,按文档再手动集成一次.</p>
<p>下面列出的的步骤一般很少用到.如果你按下面的步骤完成了集成，请在完成集成后，再按步骤检查一次.</p>
<h2 id="ios_1">iOS 平台手动集成</h2>
<p>Drag and drop the following frameworks from the <strong>plugins/ios</strong> folder of the <code>IAP</code> bundle into your Xcode project, check <code>Copy items if needed</code> when adding frameworks:
拖拽下列 framework 从 <code>IAP</code> 插件包的 <strong>plugins/ios</strong> 目录到您的 Xcode 工程中，在添加 frameworks 的时候，请勾选 <code>Copy items if needed</code> 。</p>
<blockquote>
<p>sdkbox.framework</p>
<p>PluginIAP.framework</p>
</blockquote>
<p>上面的 frameworks 依赖于其他 frameworks。如果您没有添加它们，您也需要添加下列这些 frameworks：</p>
<blockquote>
<p>Security.framework</p>
<p>StoreKit.framework</p>
<p>SystemConfiguration.framework</p>
</blockquote>
<p>把 <code>plugin/luabindings</code> 文件夹中所有的头文件和源文件都拷贝到你的工程的 <code>Classes</code> 文件夹中.</p>
<p>把刚刚拷贝的文件拖动到 Xcode 中或使用 <strong>File -&gt; Add files to...</strong> 来添加.</p>
<h2 id="android_1">Android 平台手动集成</h2>
<h3 id="_12">拷贝文件</h3>
<p>从插件安装包中的 <code>plugin/android/libs</code> 目录拷贝下列 <strong>jar</strong> 文件到您的工程的 <strong>proj.android/libs</strong> 目录。</p>
<blockquote>
<p>PluginGooglePlay.jar</p>
<p>PluginIAP.jar</p>
<p>sdkbox.jar</p>
</blockquote>
<ul>
<li>
<p>如果你使用 cocos2d-x 源码，拷贝 <strong>jar</strong> 文件到：</p>
<p>Android command-line:
<code>cocos2d/cocos/platform/android/java/libs</code></p>
<p>Android Studio:
<code>cocos2d/cocos/platform/android/libcocos2dx/libs</code></p>
</li>
<li>
<p>如果你使用 cocos2d-js 或者 lua ，拷贝 <strong>jar</strong> 文件到:</p>
<p>Android command-line:
<code>frameworks/cocos2d-x/cocos/platform/android/java/libs</code></p>
<p>Android Studio:
<code>frameworks/cocos2d-x/cocos/platform/android/libcocos2dx/libs</code></p>
</li>
<li>
<p>如果你使用 cocos2d-x 预编译包，拷贝 <strong>jar</strong> 文件到：</p>
<p>Android command-line:
<code>proj.android/libs</code></p>
</li>
</ul>
<p>从 <code>plugin/android/jni</code> 目录拷贝 <code>pluginiap</code> 以及 <code>sdkbox</code> 目录到您的工程的 <code>proj.android/jni</code> 目录。如果 <code>sdkbox</code> 目录在工程中已经存在，请覆盖它。</p>
<h3 id="androidmanifestxml">编辑 <code>AndroidManifest.xml</code></h3>
<p>在标签 <strong>application tag</strong> 上添加下列权限：</p>
<pre><code class="xml">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot; /&gt;
&lt;uses-permission android:name=&quot;com.android.vending.BILLING&quot;/&gt;
</code></pre>

<h3 id="androidmk">编辑 <code>Android.mk</code></h3>
<p>编辑 <code>proj.android/jni/Android.mk</code>：</p>
<p>为 <strong>LOCAL_STATIC_LIBRARIES</strong> 添加额外的库：</p>
<pre><code>LOCAL_STATIC_LIBRARIES += PluginIAP
LOCAL_STATIC_LIBRARIES += sdkbox
</code></pre>

<p>在所有 <strong>import-module</strong> 语句之前添加一条 call 语句：</p>
<pre><code>$(call import-add-path,$(LOCAL_PATH))
</code></pre>

<p>在最后添加额外的 <strong>import-module</strong> 语句：</p>
<pre><code>$(call import-module, ./sdkbox)
$(call import-module, ./pluginiap)
</code></pre>

<p>这意味着您的语句顺序看起来像是这样：</p>
<pre><code>$(call import-add-path,$(LOCAL_PATH))
$(call import-module, ./sdkbox)
$(call import-module, ./pluginiap)
</code></pre>

<p><strong>Note:</strong> 如果您使用的是 cocos2d-x 预编译库，那么保证这些语句在已有的 <code>$(call import-module,./prebuilt-mk)</code> 语句之上非常重要。</p>
<h3 id="applicationmk-cocos2d-x-v30-v32">编辑 <code>Application.mk</code> （只限 Cocos2d-x v3.0 到 v3.2 版本）</h3>
<p>编辑 <code>proj.android/jni/Application.mk</code> 保证 <strong>APP_STL</strong> 的定义正确。如果 <code>Application.mk</code> 包含了 <code>APP_STL := c++_static</code> 语句，那么这条语句应该被改为：</p>
<pre><code>APP_STL := gnustl_static
</code></pre>

<p>把 <code>plugin/luabindings</code> 文件夹中所有的头文件和源文件都拷贝到你的工程的 <code>Classes</code> 文件夹中.</p>
<p>把你刚刚拷贝的 <code>.cpp</code> 文件添加到 <code>Android.mk</code> 文件的的 <strong>LOCAL_SRC_FILES</strong> 项.比如</p>
<pre><code>LOCAL_SRC_FILES := hellocpp/main.cpp \
                ../../Classes/AppDelegate.cpp \
                ../../Classes/HelloWorldScene.cpp \
                                ../../Classes/NewSourceFile.cpp
</code></pre>

<h3 id="appactivityjava">修改 <code>AppActivity.java</code></h3>
<h4 id="2403">插件版本 &gt;= 2.4.0.3</h4>
<ol>
<li>找到 <strong>AppActivity.java</strong> 文件</li>
</ol>
<pre><code class="bash">find . -name &quot;AppActivity.java&quot;
</code></pre>

<ol>
<li>把 <code>extends Cocos2dxActivity</code> 替换为 <code>extends com.sdkbox.plugin.SDKBoxActivity</code></li>
</ol>
<p>以下是 <strong>AppActivity.java</strong> 不同版本的引擎所在的目录：</p>
<pre><code>cpp
  - proj.android/src/org/cocos2dx/cpp/AppActivity.java
  - proj.android-studio/app/src/org/cocos2dx/cpp/AppActivity.java
  - proj.android/app/src/org/cocos2dx/cpp/AppActivity.java ( from cocos2d-x 3.17)

lua
  - frameworks/runtime-src/proj.android/src/org/cocos2dx/lua/AppActivity.java
  - frameworks/runtime-src/proj.android-studio/app/src/org/cocos2dx/lua/AppActivity.java
  - frameworks/runtime-src/proj.android/app/src/org/cocos2dx/lua/AppActivity.java (from cocos2d-x 3.17)

js
  - frameworks/runtime-src/proj.android/src/org/cocos2dx/javascript/AppActivity.java
  - frameworks/runtime-src/proj.android/app/src/org/cocos2dx/javascript/AppActivity.java ( from cocos2d-x 3.17)
</code></pre>

<h4 id="2403_1">插件版本 &lt; 2.4.0.3</h4>
<ul>
<li>
<p>如果您使用 cocos2d-x 源代码，假设您在 <code>proj.android</code> 目录下，那么您可以在如下位置找到 <code>Cocos2dxActivity.java</code> 文件：</p>
<p><code>../../cocos2d-x/cocos/platform/android/java/src/org/cocos2dx/
lib/Cocos2dxActivity.java</code></p>
</li>
<li>
<p>如果您使用 cocos2dx-x 预编译库， 假设您在 <code>proj.android</code> 目录下，那么您可以在如下位置找到 <code>Cocos2dxActivity.java</code> 文件：</p>
<p><code>./src/org/cocos2dx/lib/Cocos2dxActivity.java</code></p>
</li>
</ul>
<p><strong>Note:</strong> 当你使用 cocos2d-x 源代码时，不同的版本中 <code>Cocos2dxActivity.java</code> 文件的位置也不同。一个确定该文件位置的方法是查看 <code>proj.android/project.properties</code> 。比如：</p>
<pre><code>android.library.reference.1=../../cocos2d-x/cocos/platform/android/java
</code></pre>

<p>在这个例子中， <code>Cocos2dxActivity.java</code> 文件应该在如下位置：</p>
<pre><code>../../cocos2d-x/cocos/platform/android/java/src/org/cocos2dx/lib/Cocos2dxActivity.java
</code></pre>

<ul>
<li>修改 <code>Cocos2dxActivity.java</code> 文件，导入如下包：</li>
</ul>
<pre><code class="java">import android.content.Intent;
import com.sdkbox.plugin.SDKBox;
</code></pre>

<ul>
<li>然后，修改 <code>Cocos2dxActivity</code> 类的 <code>onCreate(final Bundle savedInstanceState)</code> 函数，添加一个调用语句 <code>SDKBox.init(this);</code> 。添加的位置非常重要，必须在调用 <code>onLoadNativeLibraries();</code> 之后。如下：</li>
</ul>
<pre><code class="java">onLoadNativeLibraries();
SDKBox.init(this);
</code></pre>

<ul>
<li>
<p>最后, 我需要提供合适的 <strong>overrides</strong> 方法的代码。这里有一些约定如下。</p>
<ul>
<li>
<p>如果这个被列出的方法没有在 <code>SDKBox</code> 中定义，那么__定义它__。</p>
</li>
<li>
<p>如果这个被列出的方法已经被定义在 <code>SDKBox</code> 中，那么请调用这个在 <code>SDKBox</code> 中的__同名方法__。</p>
</li>
</ul>
</li>
</ul>
<pre><code class="java">    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
          if(!SDKBox.onActivityResult(requestCode, resultCode, data)) {
            super.onActivityResult(requestCode, resultCode, data);
          }
    }
    @Override
    protected void onStart() {
          super.onStart();
          SDKBox.onStart();
    }
    @Override
    protected void onStop() {
          super.onStop();
          SDKBox.onStop();
    }
    @Override
    protected void onResume() {
          super.onResume();
          SDKBox.onResume();
    }
    @Override
    protected void onPause() {
          super.onPause();
          SDKBox.onPause();
    }
    @Override
    public void onBackPressed() {
          if(!SDKBox.onBackPressed()) {
            super.onBackPressed();
          }
    }
</code></pre></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Build Date UTC : 2021-09-18 05:20:21, Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        
        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script>var base_url = '../../..';</script>
        <script src="../../../js/base.js"></script>
        


        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-70044300-2', 'auto');
            ga('send', 'pageview');
        </script>
        
    </body>
</html>
